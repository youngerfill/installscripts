#!/bin/bash

. rabot-utils
if [ "$?" -ne "0" ]; then
  echo "$0: Error while sourcing rabot-utils" >&2
  exit 1
fi

function showHelp
{
cat << DOCSTRING
Usage: $(basename "$0") CONFIG_FILE

'$(basename "$0")' creates a QEMU virtual machine and installs Void Linux on it.
Must be run as root.
CONFIG_FILE must exist as a shell script with some necessary variable definitions in it.
DOCSTRING
}

checkForHelp $1
minNumArgs 1 $#
requireRoot

require qemu-img
require modprobe
require rmmod
require qemu-nbd
require sfdisk
require xbps-install
require xgenfstab

config_file="$1"

# Source config file
try test -f "$config_file"
try source "$config_file"

# Check if required variables are non-empty
try test -n "$vm_name"
try test -n "$img_size"

# Set other variables to default values, if empty
: ${timezone:=UTC}
: ${username:=me}
: ${userpwd:=$username}

# Directory $vm_name must not exist
###########################
# TODO : REMOVE !!!!
try rm -rf "$vm_name"
###########################
try test ! -d "$vm_name"

# Create directory $vm_name and cd into it
try mkdir -p "$vm_name"
try cd "$vm_name"

# Keep basename
vm_name="$(basename "$vm_name")"

# Create image file
image_file="$vm_name.qcow2"
try qemu-img create -f qcow2 "$image_file" "$img_size"

# Enable nbd
try modprobe nbd max_part=8
defer rmmod nbd
defer sleep 1
device="/dev/nbd0"
try test -e "$device"

# Connect image as network block device
try qemu-nbd --connect="$device" "$image_file"
defer qemu-nbd --disconnect $device
sleep 1

# Partition
try sfdisk --label gpt --wipe always --wipe-partitions always "$device" << EOF
size=100M,type=21686148-6449-6E6F-744E-656564454649
type=L
EOF

# Format EFI partition
sleep 1
try test -e "${device}p1"
try mkfs.fat -F32 "${device}p1"

# Format root partition
try test -e "${device}p2"
try mkfs.ext4 "${device}p2"

# Mount root partition
rootdir="/mnt/$vm_name"
try mkdir -p "$rootdir"
try mount "${device}p2" "$rootdir"
defer umount "$rootdir"

# Mount EFI partition
try mkdir -p "$rootdir/boot/efi"
try mount "${device}p1" "$rootdir/boot/efi"
defer umount "$rootdir/boot/efi"

# Install base system
arch="x86_64"
try mkdir -p "$rootdir/var/db/xbps/keys"
try cp /var/db/xbps/keys/* "$rootdir/var/db/xbps/keys/"
XBPS_ARCH="$arch" xbps-install -S -r "$rootdir" base-system
try mkdir -p "$rootdir/etc"
try xgenfstab -U "$rootdir" > "$rootdir/etc/fstab"

# chroot into root directory
xchroot "$rootdir" /bin/bash
# xchroot "$rootdir" /bin/bash << EOF
#
# # Generate locale files
# xbps-reconfigure -f glibc-locales
#
# # Set timezone
# ln -sf "/usr/share/zoneinfo/$timezone" /etc/localtime
#
# # TODO: install & enable Chrony NTP service
# # TODO: dhcpd, sshd
# # TODO:
# #   - append "KEYMAP=$keymap" to /etc/rc.conf
# #       - maybe replace the entire contents
# #   - only if $keymap is not empty
# #   - for "be" layout: be-latin1
# #
# EOF
# sleep 1
